<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUTOTRADER-SAÍDA</title>
  <!-- BUILD:2026-01-25_AVP1 -->
  <!-- PRAZO:OK -->
  <style>
    :root{
      --bg:#051b22;
      --panel:#06242e;
      --panel2:#05212a;
      --line:#0c3a46;
      --txt:#e9f3f6;
      --muted:#9fb6bf;
      --orange:#ff8a00;
      --green:#00d884;
      --red:#ff4d4d;
      --btn:#0b2f3a;
      --shadow:0 12px 28px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 15% 0%, #0b2f3a 0%, var(--bg) 55%);
      color:var(--txt);
    }
    .container{
      max-width:1480px; margin:26px auto 60px; padding:0 18px;
    }
    .top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px; margin-bottom:14px;
    }
    h1{ margin:0; font-size:36px; letter-spacing:.5px }
    .subtitle{ margin:6px 0 0; color:var(--muted); font-size:14px }
    .badge{
      background:rgba(0,0,0,.25); border:1px solid var(--line); padding:10px 14px; border-radius:999px;
      box-shadow:var(--shadow); min-width:180px; text-align:center;
    }
    .badge .label{ color:var(--muted); font-size:12px }
    .badge .value{ font-family:var(--mono); font-size:14px; margin-top:3px }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0));
      border:1px solid var(--line); border-radius:var(--radius);
      padding:18px 18px 16px; box-shadow:var(--shadow); margin-top:14px;
    }
    .panel h2{
      margin:0 0 12px; color:var(--orange); letter-spacing:.6px; font-size:18px; font-weight:800;
    }
    .form-row{
      display:grid;
      grid-template-columns: 120px 140px 220px 280px 120px 200px;
      gap:12px; align-items:end;
    }
    .field label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px }
    select, input{
      width:100%; padding:10px 12px; border-radius:12px;
      background:rgba(0,0,0,.18); border:1px solid var(--line); color:var(--txt);
      outline:none;
    }
    input[readonly]{ color:#cfe2ea }
    .sidebox{ display:flex; gap:10px }
    .btn{
      cursor:pointer; user-select:none;
      padding:10px 14px; border-radius:12px;
      border:1px solid var(--line); background:var(--btn); color:var(--txt);
      font-weight:800; letter-spacing:.2px;
    }
    .btn:hover{ filter:brightness(1.08) }
    .btn-orange{ border-color:rgba(255,138,0,.55); color:var(--orange) }
    .btn-green.active{ border-color:rgba(0,216,132,.7); color:var(--green) }
    .btn-red.active{ border-color:rgba(255,77,77,.7); color:var(--red) }
    .btn-sm{ padding:7px 10px; font-size:13px; border-radius:10px }
    .hint{ margin-top:10px; color:var(--muted); font-size:13px }
    .error{ margin-top:8px; color:var(--red); font-weight:800; font-size:13px }
    table{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
      border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.10);
    }
    thead th{
      text-align:left; padding:12px 10px; color:var(--orange); font-size:12px; letter-spacing:.6px;
      border-bottom:1px solid var(--line);
    }
    tbody td{ padding:12px 10px; border-bottom:1px solid rgba(12,58,70,.45); font-size:13px; color:#d9eef5 }
    tbody tr:last-child td{ border-bottom:none }
    .par{ color:var(--orange); font-weight:900 }
    .side-long{ color:var(--green); font-weight:900 }
    .side-short{ color:var(--red); font-weight:900 }
    .pct-pos{ color:var(--green); font-weight:900 }
    .pct-neg{ color:var(--red); font-weight:900 }
    .chips{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }
    .chip{ background:rgba(0,0,0,.25); border:1px solid var(--line); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:12px }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
    .total{ color:var(--muted); font-size:13px }
    .grid-2{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:12px }
    @media (max-width: 1100px){ .form-row{ grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <div>
        <h1>AUTOTRADER-SAÍDA</h1>
        <div class="subtitle">Página única (SAÍDA): Entrada da operação + Monitoramento automático</div>
      </div>
      <div class="badge">
        <div class="label">Atualizado:</div>
        <div class="value" id="updatedLabel">—</div>
      </div>
    </div>

    <section class="panel" id="panelEntrada">
      <h2>DADOS DE ENTRADA NA OPERAÇÃO</h2>

      <div class="form-row">
        <div class="field">
          <label>PAR</label>
          <select id="parSelect"></select>
        </div>

        <div class="field">
          <label>SIDE</label>
          <div class="sidebox">
            <button class="btn btn-green active" id="btnLong" data-side="LONG">LONG</button>
            <button class="btn btn-red" id="btnShort" data-side="SHORT">SHORT</button>
          </div>
        </div>

        <div class="field">
          <label>ENTRADA</label>
          <input id="entradaInput" placeholder="ex: 1.234" inputmode="decimal" />
        </div>

        <div class="field">
          <label>US ALVO (do PRO, congelado)</label>
          <input id="alvoInput" placeholder="—" readonly />
        </div>

        <div class="field">
          <label>ALAV</label>
          <input id="alavInput" placeholder="10" inputmode="numeric" />
        </div>

        <div class="field">
          <button class="btn btn-orange" id="btnAdd" style="width:100%; padding:12px 14px;">Adicionar Operação</button>
        </div>
      </div>

      <div class="hint">Alvo do PRO: <span id="alvoLabel">—</span></div>
      <div class="error" id="addError" style="display:none;"></div>
    </section>

    <section class="panel" id="panelMonitor">
      <div class="toolbar">
        <h2 style="margin:0;">MONITORAMENTO DAS OPERAÇÕES</h2>
        <div class="grid-2">
          <div class="total">Total: <b id="totalMon">0</b></div>
          <button class="btn btn-orange btn-sm" id="btnPdfMon">Baixar PDF</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table id="tblMon">
          <thead>
            <tr>
              <th>PAR</th><th>SIDE</th><th>ENTRADA</th><th>ALVO</th><th>ALAV</th>
              <th>DATA REG</th><th>HORA REG</th><th>ATUAL</th>
              <th>GANHO ALVO</th><th>GANHO ATUAL</th><th>SITUAÇÃO</th>
              <th>DATA ATUAL</th><th>HORA ATUAL</th><th>SAIR</th><th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbodyMon">
            <tr><td colspan="15" style="color:var(--muted);">Carregando…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="chips">
        <span class="chip">Auto-refresh: 15s</span>
        <span class="chip">Worker: 5 min</span>
        <span class="chip">ALVO fixo (congelado no ADD)</span>
      </div>
    </section>

    <section class="panel" id="panelReal">
      <div class="toolbar">
        <h2 style="margin:0;">OPERAÇÕES REALIZADAS</h2>
        <div class="grid-2">
          <div class="total">Total: <b id="totalReal">0</b></div>
          <button class="btn btn-orange btn-sm" id="btnPdfReal">Baixar PDF</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table id="tblReal">
          <thead>
            <tr>
              <th>PAR</th><th>SIDE</th><th>ENTRADA</th><th>ALVO</th><th>ALAV</th>
              <th>DATA REG</th><th>HORA REG</th><th>ATUAL</th>
              <th>GANHO ALVO</th><th>GANHO ATUAL</th><th>SITUAÇÃO</th>
              <th>DATA ATUAL</th><th>HORA ATUAL</th><th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbodyReal">
            <tr><td colspan="14" style="color:var(--muted);">Sem operações realizadas.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="chips">
        <span class="chip">Sem atualização automática</span>
        <span class="chip">Cópia congelada no clique SAIR</span>
      </div>
    </section>
  </div>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  function fmt3(x){
    const n = Number(x);
    if (!isFinite(n)) return "—";
    return n.toFixed(3);
  }
  function fmt2pct(x){
    const n = Number(x);
    if (!isFinite(n)) return "—";
    return (n>=0?"+":"") + n.toFixed(2) + "%";
  }
  function splitBrt(dt){
    if (!dt) return ["—","—"];
    const s = String(dt);
    if (s.includes(" ")){
      const parts = s.split(" ");
      const d = parts[0] || "—";
      const t = (parts[1] || "—").slice(0,5);
      return [d, t];
    }
    const m = s.match(/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})/);
    if (m) return [m[1], m[2]];
    return ["—","—"];
  }

  async function jget(url){
    const r = await fetch(url, { cache: "no-store" });
    let j = null;
    try { j = await r.json(); } catch (_) {}
    if (!r.ok){
      const msg = (j && (j.msg || j.error)) ? (j.msg || j.error) : ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }
  async function jpost(url, body){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {}),
      cache: "no-store"
    });
    let j = null;
    try { j = await r.json(); } catch (_) {}
    if (!r.ok){
      const msg = (j && (j.msg || j.error)) ? (j.msg || j.error) : ("HTTP " + r.status);
      throw new Error(msg);
    }
    return j;
  }

  function setSide(side){
    const isLong = (side === "LONG");
    $("btnLong").classList.toggle("active", isLong);
    $("btnShort").classList.toggle("active", !isLong);
  }
  function getSide(){
    return $("btnLong").classList.contains("active") ? "LONG" : "SHORT";
  }
  function getPar(){
    return ($("parSelect").value || "").trim();
  }

  const LS_KEY = "saida_realizadas_v1";
  function loadReal(){
    try {
      const arr = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    } catch(_) {
      return [];
    }
  }
  function saveReal(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr || []));
  }

  const COINS = ["AAVE","ADA","APT","ARB","ATOM","AVAX","AXS","BCH","BNB","BTC","DOGE","DOT","ETH","FET","FIL","FLUX","ICP","INJ","LDO","LINK","LTC","NEAR","OP","PEPE","POL","RATS","RENDER","RUNE","SEI","SHIB","SOL","SUI","TIA","TNSR","TON","TRX","UNI","WIF","XRP"];
  function fillCoins(){
    const sel = $("parSelect");
    sel.innerHTML = '<option value="">—</option>' + COINS.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  async function fetchAlvo(){
    const par = getPar();
    const side = getSide();
    const alvoInput = $("alvoInput");
    const alvoLabel = $("alvoLabel");
    const err = $("addError");

    err.style.display = "none";

    if (!par){
      alvoInput.value = "";
      alvoInput.placeholder = "—";
      alvoLabel.textContent = "—";
      return;
    }

    const url = `/api/saida/alvo?par=${encodeURIComponent(par)}&side=${encodeURIComponent(side)}`;
    try {
      const j = await jget(url);
      const alvo = j && j.alvo;
      alvoInput.value = (alvo===0 || alvo) ? fmt3(alvo) : "—";
      alvoLabel.textContent = (alvo===0 || alvo) ? fmt3(alvo) : "—";
    } catch(e) {
      alvoInput.value = "";
      alvoInput.placeholder = "—";
      alvoLabel.textContent = "—";
      err.textContent = "ERRO: " + (e && e.message ? e.message : e);
      err.style.display = "block";
    }
  }

  async function addOp(){
    const par = getPar();
    const side = getSide();
    const entradaRaw = $("entradaInput").value.trim().replace(",", ".");
    const alavRaw = $("alavInput").value.trim();
    const alvoRaw = $("alvoInput").value.trim().replace(",", ".");

    const err = $("addError");
    err.style.display = "none";

    if (!par){ err.textContent="ERRO: PAR vazio."; err.style.display="block"; return; }
    if (!entradaRaw){ err.textContent="ERRO: ENTRADA vazia."; err.style.display="block"; return; }
    if (!alavRaw){ err.textContent="ERRO: ALAV vazia."; err.style.display="block"; return; }

    const entrada = Number(entradaRaw);
    const alav = Number(alavRaw);
    const alvo = Number(alvoRaw);

    if (!isFinite(entrada)){ err.textContent="ERRO: ENTRADA inválida."; err.style.display="block"; return; }
    if (!isFinite(alav) || alav<=0){ err.textContent="ERRO: ALAV inválida."; err.style.display="block"; return; }
    if (!isFinite(alvo)){ err.textContent="ERRO: ALVO indisponível (aguarde)."; err.style.display="block"; return; }

    try {
      try {
        await jpost("/api/saida/add", { par, side, entrada, alvo, alav });
      } catch(_) {
        await jpost("/api/saida/op", { par, side, entrada, alvo, alav });
      }
      $("entradaInput").value = "";
      await refresh();
    } catch(e) {
      err.textContent = "ERRO: " + (e && e.message ? e.message : e);
      err.style.display = "block";
    }
  }

  function td(text, cls){
    const el = document.createElement("td");
    if (cls) el.className = cls;
    el.textContent = text;
    return el;
  }

  function renderMonitor(rows){
    const tb = $("tbodyMon");
    tb.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const c = document.createElement("td");
      c.colSpan = 15;
      c.style.color = "var(--muted)";
      c.textContent = "Sem operações no momento.";
      tr.appendChild(c);
      tb.appendChild(tr);
      return;
    }

    for (const o of rows){
      const tr = document.createElement("tr");

      const sideCls = (String(o.side||"").toUpperCase()==="LONG") ? "side-long" : "side-short";
      const [dreg, hreg] = splitBrt(o.created_brt || o.created_ts);
      const [dat, hat] = splitBrt(o.updated_brt || o.updated_ts || o.pro_updated_brt);

      tr.appendChild(td(o.par || "—", "par"));
      tr.appendChild(td(String(o.side||"—").toUpperCase(), sideCls));
      tr.appendChild(td(fmt3(o.entrada)));
      tr.appendChild(td(fmt3(o.alvo)));
      tr.appendChild(td(String(o.alav ?? "—")));
      tr.appendChild(td(dreg));
      tr.appendChild(td(hreg));
      tr.appendChild(td(fmt3(o.atual)));

      const ga = (o.ganho_alvo_pct ?? o.ganho_alvo ?? o.ganhoAlvo);
      const gt = (o.ganho_atual_pct ?? o.ganho_atual ?? o.ganhoAtual);

      tr.appendChild(td(fmt2pct(ga), (Number(ga)>=0) ? "pct-pos":"pct-neg"));
      tr.appendChild(td(fmt2pct(gt), (Number(gt)>=0) ? "pct-pos":"pct-neg"));

      tr.appendChild(td(o.situacao || (o.atual ? "EM ANDAMENTO" : "AGUARDANDO WORKER")));
      tr.appendChild(td(dat));
      tr.appendChild(td(hat));

      const tdSair = document.createElement("td");
      const bSair = document.createElement("button");
      bSair.className = "btn btn-orange btn-sm";
      bSair.textContent = "SAIR";
      bSair.onclick = async () => {
        if (!confirm("Confirmar SAIR desta operação?")) return;

        const snap = {
          id: o.id,
          par: o.par,
          side: o.side,
          entrada: o.entrada,
          alvo: o.alvo,
          alav: o.alav,
          created_ts: o.created_ts,
          created_brt: o.created_brt,
          atual: o.atual,
          ganho_alvo_pct: ga,
          ganho_atual_pct: gt,
          situacao: o.situacao || "REALIZADA",
          moved_brt: new Date().toLocaleString("sv-SE").replace("T"," ").slice(0,16)
        };

        try { await jpost("/api/saida/sair", { id: o.id }); } catch(_) {}

        const arr = loadReal();
        if (!arr.some(x => x && x.id === snap.id)) arr.unshift(snap);
        saveReal(arr);
        await refresh();
      };
      tdSair.appendChild(bSair);
      tr.appendChild(tdSair);

      const tdExc = document.createElement("td");
      const bExc = document.createElement("button");
      bExc.className = "btn btn-sm";
      bExc.style.borderColor = "rgba(255,77,77,.55)";
      bExc.style.color = "var(--red)";
      bExc.textContent = "EXCLUIR";
      bExc.onclick = async () => {
        if (!confirm("Confirmar EXCLUIR esta operação?")) return;
        try { await jpost("/api/saida/excluir", { id: o.id }); } catch(_) {}
        const arr = loadReal().filter(x => x && x.id !== o.id);
        saveReal(arr);
        await refresh();
      };
      tdExc.appendChild(bExc);
      tr.appendChild(tdExc);

      tb.appendChild(tr);
    }
  }

  function renderRealizadas(rows){
    const tb = $("tbodyReal");
    tb.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const c = document.createElement("td");
      c.colSpan = 14;
      c.style.color = "var(--muted)";
      c.textContent = "Sem operações realizadas.";
      tr.appendChild(c);
      tb.appendChild(tr);
      return;
    }

    for (const o of rows){
      const tr = document.createElement("tr");

      const sideCls = (String(o.side||"").toUpperCase()==="LONG") ? "side-long" : "side-short";
      const [dreg, hreg] = splitBrt(o.created_brt || o.created_ts);
      const [dat, hat] = splitBrt(o.moved_brt);

      tr.appendChild(td(o.par || "—", "par"));
      tr.appendChild(td(String(o.side||"—").toUpperCase(), sideCls));
      tr.appendChild(td(fmt3(o.entrada)));
      tr.appendChild(td(fmt3(o.alvo)));
      tr.appendChild(td(String(o.alav ?? "—")));
      tr.appendChild(td(dreg));
      tr.appendChild(td(hreg));
      tr.appendChild(td(fmt3(o.atual)));

      const ga = (o.ganho_alvo_pct ?? o.ganho_alvo);
      const gt = (o.ganho_atual_pct ?? o.ganho_atual);

      tr.appendChild(td(fmt2pct(ga), (Number(ga)>=0) ? "pct-pos":"pct-neg"));
      tr.appendChild(td(fmt2pct(gt), (Number(gt)>=0) ? "pct-pos":"pct-neg"));

      tr.appendChild(td(o.situacao || "REALIZADA"));
      tr.appendChild(td(dat));
      tr.appendChild(td(hat));

      const tdExc = document.createElement("td");
      const bExc = document.createElement("button");
      bExc.className = "btn btn-sm";
      bExc.style.borderColor = "rgba(255,77,77,.55)";
      bExc.style.color = "var(--red)";
      bExc.textContent = "EXCLUIR";
      bExc.onclick = async () => {
        if (!confirm("Excluir do histórico?")) return;
        const arr = loadReal().filter(x => x && x.id !== o.id);
        saveReal(arr);
        await refresh();
      };
      tdExc.appendChild(bExc);
      tr.appendChild(tdExc);

      tb.appendChild(tr);
    }
  }

  async function refresh(){
    window.refresh = refresh; // garante typeof window.refresh !== undefined

    await fetchAlvo();

    let base = { ops: [] };
    let mon = { ops: [] };

    try { base = await jget("/api/saida/ops"); } catch(_) {}
    try { mon = await jget("/api/saida/monitor"); } catch(_) {}

    const updated = mon.updated_brt || base.updated_brt || "—";
    $("updatedLabel").textContent = updated;

    const baseMap = new Map((base.ops || []).map(o => [o.id, o]));
    const merged = (mon.ops || []).map(m => Object.assign({}, baseMap.get(m.id) || {}, m));

    const realIds = new Set(loadReal().map(x => x && x.id).filter(Boolean));
    const monitorRows = merged.filter(o => o && o.id && !realIds.has(o.id));

    renderMonitor(monitorRows);
    $("totalMon").textContent = String(monitorRows.length);

    const realRows = loadReal();
    renderRealizadas(realRows);
    $("totalReal").textContent = String(realRows.length);
  }

  function downloadPdfOf(panelId, filename){
    const panel = document.getElementById(panelId);
    if (!panel) return;

    const w = window.open("", "_blank");
    if (!w){
      alert("Bloqueio de pop-up. Permita pop-ups para baixar PDF.");
      return;
    }
    const css = document.querySelector("style") ? document.querySelector("style").innerHTML : "";
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"/><title>${filename}</title><style>${css}</style></head><body>${panel.outerHTML}</body></html>`);
    w.document.close();
    w.focus();
    w.print();
    setTimeout(() => w.close(), 300);
  }

  function init(){
    fillCoins();

    $("btnLong").onclick = () => { setSide("LONG"); fetchAlvo(); };
    $("btnShort").onclick = () => { setSide("SHORT"); fetchAlvo(); };
    $("parSelect").onchange = () => fetchAlvo();

    $("btnAdd").onclick = () => addOp();

    $("btnPdfMon").onclick = () => downloadPdfOf("panelMonitor", "monitoramento.pdf");
    $("btnPdfReal").onclick = () => downloadPdfOf("panelReal", "operacoes_realizadas.pdf");

    refresh();
    setInterval(() => { refresh().catch(() => {}); }, 15000);
  }

  init();
})();
</script>
</body>
</html>
