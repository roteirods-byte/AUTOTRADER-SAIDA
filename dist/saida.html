cd /home/roteiro_ds/AUTOTRADER-SAIDA || exit 1

echo "=== BACKUP ==="
cp -a dist/saida.html "dist/saida.html.bak.$(date +%F_%H%M%S)"

echo "=== PATCH (front) ==="
python3 - <<'PY'
from pathlib import Path
import re, sys

p = Path("dist/saida.html")
s = p.read_text(encoding="utf-8", errors="replace")

# 1) textos do header (remove "/")
s = s.replace("GANHO / ALVO", "GANHO ALVO").replace("GANHO / ATUAL", "GANHO ATUAL")

# 2) CSS: botão SAIR verde + aumentar largura + colunas (DATA ATUAL / SITUAÇÃO)
css_add = """
/* --- FIX SAIDA (UI) --- */
.wrap, .container, .main, .main-wrap { max-width: 1480px !important; }
table { width: 100% !important; table-layout: fixed !important; }
th, td { white-space: nowrap !important; }
th:nth-child(11), td:nth-child(11) { width: 180px !important; } /* SITUAÇÃO */
th:nth-child(12), td:nth-child(12) { width: 125px !important; } /* DATA ATUAL */
th:nth-child(6),  td:nth-child(6)  { width: 115px !important; } /* DATA REG */
th:nth-child(7),  td:nth-child(7)  { width: 80px !important; }  /* HORA REG */
button.sbtn { background:#00b050 !important; border:1px solid #00b050 !important; color:#fff !important; }
button.sbtn:disabled { opacity:.6; cursor:not-allowed; }
"""

if "</style>" in s and "FIX SAIDA (UI)" not in s:
    s = s.replace("</style>", css_add + "\n</style>", 1)

# 3) Helpers: data/hora BR e split do updated_brt
def ensure_helpers(text: str) -> str:
    if "function fmtBrtFromIso" in text and "function fmtDateISO" in text:
        return text

    insert_after = re.search(r"function\s+fmtPct\([^\)]*\)\s*\{.*?\}\s*", text, flags=re.S)
    if not insert_after:
        print("ERRO: não achei function fmtPct() no dist/saida.html")
        sys.exit(2)

    helpers = r"""
  function fmtBrtFromIso(ts){
    try{
      if(!ts) return {date:"", time:""};
      const d = new Date(ts);
      const date = d.toLocaleDateString("pt-BR");
      const time = d.toLocaleTimeString("pt-BR", {hour:"2-digit", minute:"2-digit"});
      return {date, time};
    }catch(e){
      return {date:"", time:""};
    }
  }

  function fmtDateISO(ymd){
    if(!ymd) return "";
    const m = String(ymd).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return ymd;
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
"""
    i = insert_after.end()
    return text[:i] + helpers + text[i:]

s = ensure_helpers(s)

# 4) Dentro do refresh(): criar upd_date_br / upd_time (sempre do updated_brt)
if "const upd_date_br" not in s:
    s = re.sub(
        r'const u = elUpd\(\);\s*if\s*\(u\)\s*u\.textContent\s*=\s*\(mon\.updated_brt\s*\|\|\s*"—"\);',
        'const u = elUpd();\n'
        '      const updated_brt = (mon.updated_brt || "");\n'
        '      if (u) u.textContent = (updated_brt || "—");\n'
        '      const upd_parts = updated_brt.split(" ");\n'
        '      const upd_date = upd_parts[0] || "";\n'
        '      const upd_time = upd_parts[1] || "";\n'
        '      const upd_date_br = fmtDateISO(upd_date);\n',
        s,
        count=1
    )

# 5) Trocar o bloco do TR para: (a) DATA/HORA REG vindo do created_ts (sempre), (b) DATA/HORA ATUAL do updated_brt,
#    (c) incluir SAIR verde, (d) manter EXCLUIR.
pattern = re.compile(
    r'const tr\s*=\s*document\.createElement\("tr"\);\s*tr\.innerHTML\s*=\s*`.*?`;\s*tb\.appendChild\(tr\);',
    re.S
)

replacement = r'''const tr = document.createElement("tr");

        // REGISTRO: sempre do /ops (created_ts), mesmo se ainda estiver "AGUARDANDO WORKER"
        const reg = fmtBrtFromIso(o.created_ts || o.created_at || o.created);
        const dataReg = reg.date;
        const horaReg = reg.time;

        // ATUAL: sempre do updated_brt (evita ficar quebrado/fora de linha)
        const dataAtual = upd_date_br;
        const horaAtual = upd_time || "";

        tr.innerHTML = `
          <td class="par">${o.par||""}</td>
          <td><span class="tag ${String(o.side)==="SHORT" ? "short":"long"}">${o.side||""}</span></td>
          <td>${fmtPx(o.entrada)}</td>
          <td>${fmtPx(o.alvo)}</td>
          <td>${o.alav ?? ""}</td>

          <td>${dataReg}</td>
          <td>${horaReg}</td>

          <td>${fmtPx(o.atual)}</td>
          <td class="${clsPct(gA)}">${fmtPct(gA)}</td>
          <td class="${clsPct(gU)}">${fmtPct(gU)}</td>

          <td>${o.situacao || (o.atual ? "" : "AGUARDANDO WORKER")}</td>
          <td>${dataAtual}</td>
          <td>${horaAtual}</td>

          <td><button class="sbtn" data-id="${o.id}">Sair</button></td>
          <td><button class="xbtn" data-id="${o.id}">Excluir</button></td>
        `;
        tb.appendChild(tr);'''

s2, n = pattern.subn(replacement, s, count=1)
if n != 1:
    print("ERRO: não consegui localizar o bloco do TR (render da tabela) para substituir.")
    sys.exit(3)
s = s2

# 6) Garantir que o handler do SAIR existe (se já existe, ok)
if "button.sbtn" not in s:
    print("ERRO: não achei handler do SAIR no arquivo. (me mande o /tmp/saida.js)")
    sys.exit(4)

p.write_text(s, encoding="utf-8")
print("OK: dist/saida.html atualizado")
PY

echo "=== VALIDAR JS (sem rodar navegador) ==="
awk 'BEGIN{f=0} /<script>/{f=1; next} /<\/script>/{f=0} f{print}' dist/saida.html > /tmp/saida.js
node -c /tmp/saida.js || exit 1

echo "=== RESTART API SAIDA ==="
sudo systemctl restart autotrader-saida-v2-api.service

echo "=== CHECAGEM RÁPIDA (texto novo) ==="
curl -sS https://saida1jorge.duckdns.org/saida | grep -n "GANHO ALVO\|GANHO ATUAL\|class=\"sbtn\"" | head
