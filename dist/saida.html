<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AUTOTRADER-SAÍDA</title>
  <style>
    :root{
      --bg:#061b24;
      --panel:#082733;
      --panel2:#07212b;
      --line:rgba(255,255,255,.08);
      --txt:#e9f2f6;
      --muted:#b8c7d0;
      --orange:#ff8a00;
      --green:#1fe28a;
      --red:#ff2b68;
      --chip:#0b3140;
      --btn:#0c3a4c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:22px auto;padding:0 14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .title{font-size:28px;font-weight:900;letter-spacing:.5px}
    .pill{background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 12px;border-radius:999px}
    .pill b{color:var(--orange)}
    .sub{color:var(--muted);margin-top:4px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0}
    .h{font-size:20px;font-weight:900;color:var(--orange);margin:0 0 12px}
    .grid{display:grid;grid-template-columns: 120px 160px 180px 180px 140px 220px;gap:10px;align-items:end}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    select,input{width:100%;background:rgba(0,0,0,.18);border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:10px 12px;outline:none}
    input[readonly]{opacity:.9}
    .sideBtns{display:flex;gap:10px}
    .btn{background:var(--btn);border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--orange);cursor:pointer;font-weight:800}
    .btn:active{transform:translateY(1px)}
    .btnSide{min-width:72px;color:#fff}
    .btnLong.active{outline:2px solid rgba(31,226,138,.35);background:rgba(31,226,138,.18)}
    .btnShort.active{outline:2px solid rgba(255,43,104,.35);background:rgba(255,43,104,.16)}
    .btnLong{border-color:rgba(31,226,138,.35)}
    .btnShort{border-color:rgba(255,43,104,.35)}
    .btnLong span{color:var(--green)}
    .btnShort span{color:var(--red)}
    .msg{margin-top:8px;color:var(--muted)}
    .msg b{color:var(--orange)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--line);text-align:center}
    th{color:var(--orange);font-size:12px;letter-spacing:.4px}
    td:first-child, th:first-child{text-align:left;padding-left:14px}
    tr:last-child td{border-bottom:none}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid var(--line);font-weight:900}
    .tagLong{color:var(--green);border-color:rgba(31,226,138,.35)}
    .tagShort{color:var(--red);border-color:rgba(255,43,104,.35)}
    .pos{color:var(--green);font-weight:900}
    .neg{color:var(--red);font-weight:900}
    .warn{color:var(--orange);font-weight:900}
    .btnDel{background:rgba(255,43,104,.12);border:1px solid rgba(255,43,104,.35);color:var(--red);padding:9px 12px;border-radius:10px;font-weight:900;cursor:pointer}
    .foot{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;color:var(--muted);font-size:12px}
    .chip{background:rgba(255,255,255,.06);border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">AUTOTRADER-SAÍDA</div>
        <div class="sub">Página única (SAÍDA): Entrada da operação + Monitoramento automático (a cada 5 min no worker).</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <div class="pill">Atualizado: <b id="upd">—</b></div>
      <div class="pill" style="font-size:12px">Build: <b id="build">—</b></div>
    </div>
    </div>

    <!-- PAINEL 1: ENTRADA -->
    <div class="card">
      <div class="h">DADOS DE ENTRADA NA OPERAÇÃO</div>

      <div class="grid">
        <div>
          <label>PAR</label>
          <select id="par">
            <option>AAVE</option><option>ADA</option><option>APT</option><option>ARB</option><option>ATOM</option><option>AVAX</option><option>AXS</option>
            <option>BCH</option><option>BNB</option><option>BTC</option><option>DOGE</option><option>DOT</option><option>ETH</option><option>FET</option>
            <option>FIL</option><option>FLUX</option><option>ICP</option><option>INJ</option><option>LDO</option><option>LINK</option><option>LTC</option>
            <option>NEAR</option><option>OP</option><option>PEPE</option><option>POL</option><option>RATS</option><option>RENDER</option><option>RUNE</option>
            <option>SEI</option><option>SHIB</option><option>SOL</option><option>SUI</option><option>TIA</option><option>TNSR</option><option>TON</option>
            <option>TRX</option><option>UNI</option><option>WIF</option><option>XRP</option>
          </select>
        </div>

        <div>
          <label>SIDE</label>
          <div class="sideBtns">
            <button class="btn btnSide btnLong active" id="btnLong"><span>LONG</span></button>
            <button class="btn btnSide btnShort" id="btnShort"><span>SHORT</span></button>
          </div>
        </div>

        <div>
          <label>US ENTRADA</label>
          <input id="entrada" type="number" step="0.0001" placeholder="ex: 1.3371" />
        </div>

        <div>
          <label>US ALVO (do PRO, congelado)</label>
          <input id="alvo" type="number" step="0.0001" readonly />
        </div>

        <div>
          <label>ALAV</label>
          <input id="alav" type="number" step="1" value="10" />
        </div>

        <div>
          <button class="btn" id="btnAdd" style="width:100%;height:42px">Adicionar Operação</button>
        </div>
      </div>

      <div class="msg" id="msg">Alvo do PRO: <b id="proInfo">—</b></div>
    </div>

    <!-- PAINEL 2: MONITORAMENTO -->
    <div class="card">
      <div class="h">MONITORAMENTO DAS OPERAÇÕES</div>
      <div class="msg">Total: <b id="total">0</b></div>

      <table>
        <thead>
          <tr>
            <th>PAR</th>
            <th>SIDE</th>
            <th>US ENTRADA</th>
            <th>US ALVO</th>
            <th>ALAV</th>
            <th>US ATUAL</th>
            <th>GANHO / ALVO (%)</th>
            <th>GANHO / ATUAL (%)</th>
            <th>SITUAÇÃO</th>
            <th>DATA</th>
            <th>HORA</th>
            <th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>

      <div class="foot">
        <div class="chip">Auto-refresh: 15s</div>
        <div class="chip">Worker: 5 min</div>
        <div class="chip">ALVO fixo (congelado no ADD)</div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let side = "LONG";
  function setSide(s){
    side = s;
    $("btnLong").classList.toggle("active", s==="LONG");
    $("btnShort").classList.toggle("active", s==="SHORT");
    fetchVersion();
  fetchAlvo();
  }
  $("btnLong").onclick = (e)=>{ e.preventDefault(); setSide("LONG"); };
  $("btnShort").onclick = (e)=>{ e.preventDefault(); setSide("SHORT"); };

  function fmtPx(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return "0.000";
    return n.toFixed(3);
  }
  function fmtPct(v){
    const n = Number(v);
    if (!Number.isFinite(n)) return "0.00%";
    return n.toFixed(2) + "%";
  }


  async function fetchVersion(){
    try{
      const r = await fetch("/api/saida/version", { cache: "no-store" });
      const j = await r.json();
      if (j && j.ok){
        $("build").textContent = j.build || "—";
        $("build").title = (j.started_brt ? ("START: " + j.started_brt) : "");
      }
    }catch(e){
      // não trava o painel
    }
  }

  async function fetchAlvo(){
    const par = $("par").value;
    try{
      const r = await fetch(`/api/saida/alvo?par=${encodeURIComponent(par)}&side=${encodeURIComponent(side)}`);
      const j = await r.json();
      if (!j.ok) throw new Error(j.msg || "Sem alvo");
      $("alvo").value = j.alvo;
      $("proInfo").textContent = (j.updated_brt ? ("PRO atualizado: " + j.updated_brt) : "OK");
      $("msg").classList.remove("warn");
    }catch(err){
      $("alvo").value = "";
      $("proInfo").textContent = "Sem alvo no PRO";
    }
  }

  $("par").onchange = fetchAlvo;

  $("btnAdd").onclick = async () => {
    const par = $("par").value;
    const entrada = Number($("entrada").value);
    const alav = Number($("alav").value);

    if (!Number.isFinite(entrada) || entrada<=0){
      alert("Digite US ENTRADA corretamente.");
      return;
    }
    if (!Number.isFinite(alav) || alav<1){
      alert("Digite ALAV corretamente (>=1).");
      return;
    }

    const body = { par, side, entrada, alav };

    const r = await fetch("/api/saida/add", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if (!j.ok){
      alert(j.msg || "Falha ao adicionar");
      return;
    }
    $("entrada").value = "";
    await refresh();
  };

  async function delOp(id){
    const r = await fetch("/api/saida/del", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id })
    });
    const j = await r.json();
    if (!j.ok) alert(j.msg || "Falha ao excluir");
    await refresh();
  }

  function clsPct(n){
    if (!Number.isFinite(n)) return "";
    if (n > 0) return "pos";
    if (n < 0) return "neg";
    return "warn";
  }

  async function refresh(){
    const r = await fetch("/api/saida/monitor");
    const j = await r.json();

    $("upd").textContent = j.updated_brt || "—";

    const ops = Array.isArray(j.ops) ? j.ops : [];
    $("total").textContent = ops.length;

    const tb = $("tb");
    tb.innerHTML = "";

    for (const o of ops){
      const tag = (String(o.side)==="SHORT") ? "tag tagShort" : "tag tagLong";
      const gA = Number(o.ganho_alvo_pct);
      const gU = Number(o.ganho_atual_pct);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="color:var(--orange);font-weight:900">${o.par||""}</td>
        <td><span class="${tag}">${o.side||""}</span></td>
        <td>${fmtPx(o.entrada)}</td>
        <td>${fmtPx(o.alvo)}</td>
        <td>${o.alav||""}</td>
        <td>${fmtPx(o.atual)}</td>
        <td class="${clsPct(gA)}">${fmtPct(gA)}</td>
        <td class="${clsPct(gU)}">${fmtPct(gU)}</td>
        <td>${o.situacao||""}</td>
        <td>${o.data||""}</td>
        <td>${o.hora||""}</td>
        <td><button class="btnDel" onclick="window.__del('${o.id}')">Excluir</button></td>
      `;
      tb.appendChild(tr);
    }
  }

  window.__del = delOp;

  fetchAlvo();
  refresh();
  setInterval(refresh, 15000);
  setInterval(fetchVersion, 60000);
</script>
</body>
</html>
