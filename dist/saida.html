cd /home/roteiro_ds/AUTOTRADER-SAIDA || exit 1

# backup seguro
cp -a dist/saida.html "dist/saida.html.bak.$(date +%F_%H%M%S)"

# grava o HTML novo
cat > dist/saida.html <<'HTML'
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUTOTRADER-SAÍDA</title>

  <!-- evita erro de favicon -->
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#041b23;
      --card:#062a34;
      --card2:#06303a;
      --txt:#e9f3f6;
      --muted:#9fb3ba;
      --orange:#ff8b1f;
      --green:#17c964;
      --red:#ff3b30;
      --pink:#ff3bc8;
      --btn:#0b3c47;
      --line:#0b4250;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{
      width:96%;
      max-width:1400px; /* AUMENTA LARGURA DO PAINEL */
      margin:26px auto 60px;
    }
    h1{
      margin:0 0 6px;
      letter-spacing:1px;
      font-weight:800;
      font-size:42px;
    }
    .sub{
      color:var(--muted);
      margin:0 0 18px;
      font-size:14px;
    }
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(7,54,66,.6);
      border:1px solid rgba(255,139,31,.35);
      color:var(--txt);
      font-size:14px;
      min-width:210px;
      justify-content:center;
    }
    .badge b{color:var(--orange)}
    .card{
      background:linear-gradient(180deg, rgba(6,42,52,.92), rgba(6,48,58,.86));
      border:1px solid rgba(255,255,255,.06);
      box-shadow:0 12px 30px rgba(0,0,0,.28);
      border-radius:18px;
      padding:18px 18px 16px;
      margin:14px 0;
    }
    .title{
      color:var(--orange);
      font-weight:800;
      letter-spacing:1px;
      margin:0 0 12px;
      font-size:18px;
    }

    /* FORM */
    .grid{
      display:grid;
      grid-template-columns: 120px 170px 1fr 220px 110px 180px;
      gap:12px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
      letter-spacing:.6px;
    }
    select,input{
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.08);
      background:#04232c;
      color:var(--txt);
      outline:none;
    }
    input[disabled]{opacity:.85}
    .row{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,139,31,.55);
      background:rgba(255,139,31,.08);
      color:var(--orange);
      padding:12px 14px;
      border-radius:10px;
      font-weight:800;
      letter-spacing:.2px;
      transition:.12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.6; cursor:not-allowed; transform:none}
    .toggle{
      display:flex; gap:10px;
    }
    .tbtn{
      cursor:pointer;
      border-radius:10px;
      padding:12px 16px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background:#04232c;
      color:var(--muted);
    }
    .tbtn.on.long{border-color:rgba(23,201,100,.6); color:var(--green)}
    .tbtn.on.short{border-color:rgba(255,59,48,.65); color:var(--red)}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
    .hint b{color:var(--orange)}

    /* TABELA */
    .bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:12px;
    }
    .bar .left{
      display:flex; align-items:center; gap:12px;
      color:var(--muted);
      font-size:13px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0 10px;
      table-layout:auto;
    }
    thead th{
      text-align:left;
      font-size:13px;
      color:var(--orange);
      font-weight:900;
      padding:0 10px;
      white-space:nowrap; /* NÃO QUEBRA CABEÇALHO */
    }
    tbody tr{
      background:rgba(4,35,44,.85);
      border:1px solid rgba(255,255,255,.06);
    }
    tbody td{
      padding:10px 10px;
      font-size:13px;
      border-top:1px solid rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.04);
      white-space:nowrap; /* NÃO QUEBRA DATA/SITUAÇÃO */
    }
    tbody tr td:first-child{
      border-left:1px solid rgba(255,255,255,.04);
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
    }
    tbody tr td:last-child{
      border-right:1px solid rgba(255,255,255,.04);
      border-top-right-radius:12px;
      border-bottom-right-radius:12px;
    }
    .pill{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.3px;
      border:1px solid rgba(255,255,255,.10);
    }
    .pill.short{color:var(--pink); border-color:rgba(255,59,200,.35)}
    .pill.long{color:var(--green); border-color:rgba(23,201,100,.35)}
    .pos{color:var(--green); font-weight:900}
    .neg{color:var(--red); font-weight:900}
    .muted{color:var(--muted)}
    .sit{min-width:150px}       /* AUMENTA SITUAÇÃO */
    .dateAtual{min-width:110px} /* AUMENTA DATA ATUAL */
    .horaAtual{min-width:70px}
    .actions{display:flex; gap:10px; justify-content:flex-start}

    /* BOTÕES AÇÃO */
    .sbtn{
      cursor:pointer;
      border-radius:8px;
      padding:7px 10px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.12);
      background:#0b2c34;
      color:#fff;
    }
    .sbtn:hover{transform:translateY(-1px)}
    .sbtn:disabled{opacity:.6; cursor:not-allowed; transform:none}

    /* SAIR VERDE (pedido 3) */
    .sbtn.sair{
      background:rgba(23,201,100,.14);
      border-color:rgba(23,201,100,.55);
      color:var(--green);
    }

    .sbtn.del{
      background:rgba(255,59,48,.12);
      border-color:rgba(255,59,48,.45);
      color:var(--pink);
    }

    .foot{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(7,54,66,.35);
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>AUTOTRADER-SAÍDA</h1>
        <p class="sub">Página única (SAÍDA): Entrada da operação + Monitoramento automático (a cada 5 min no worker).</p>
      </div>
      <div class="badge">Atualizado: <b id="lblUpdated">—</b></div>
    </div>

    <div class="card">
      <div class="title">DADOS DE ENTRADA NA OPERAÇÃO</div>

      <div class="grid">
        <div class="field">
          <label>PAR</label>
          <select id="par"></select>
        </div>

        <div class="field">
          <label>SIDE</label>
          <div class="toggle">
            <button class="tbtn long on" id="btnLong" type="button">LONG</button>
            <button class="tbtn short" id="btnShort" type="button">SHORT</button>
          </div>
        </div>

        <div class="field">
          <label>ENTRADA</label>
          <input id="entrada" placeholder="ex: 1.3371" />
        </div>

        <div class="field">
          <label>US ALVO (do PRO, congelado)</label>
          <input id="alvo" disabled />
        </div>

        <div class="field">
          <label>ALAV</label>
          <input id="alav" value="10" />
        </div>

        <div class="field">
          <button class="btn" id="btnAdd" type="button">Adicionar Operação</button>
        </div>
      </div>

      <div class="hint">Alvo do PRO: <b id="lblPro">—</b></div>
    </div>

    <div class="card">
      <div class="bar">
        <div class="title" style="margin:0">MONITORAMENTO DAS OPERAÇÕES</div>
        <div class="left">
          <span>Total: <b id="lblTotal">0</b></span>
          <button class="btn" id="btnPdf" type="button" style="padding:10px 12px">Baixar PDF</button>
        </div>
      </div>

      <div style="overflow:auto; border-top:1px solid rgba(255,255,255,.06); padding-top:10px;">
        <table>
          <thead>
            <tr>
              <th>PAR</th>
              <th>SIDE</th>
              <th>ENTRADA</th>
              <th>ALVO</th>
              <th>ALAV</th>
              <th>DATA REG</th>
              <th>HORA REG</th>
              <th>ATUAL</th>
              <th>GANHO ALVO</th>   <!-- pedido 6 -->
              <th>GANHO ATUAL</th>  <!-- pedido 6 -->
              <th class="sit">SITUAÇÃO</th>
              <th class="dateAtual">DATA ATUAL</th>
              <th class="horaAtual">HORA ATUAL</th>
              <th>SAIR</th>
              <th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbOps">
            <!-- linhas -->
          </tbody>
        </table>
      </div>

      <div class="foot">
        <span class="chip">Auto-refresh: 15s</span>
        <span class="chip">Worker: 5 min</span>
        <span class="chip">ALVO fixo (congelado no ADD)</span>
      </div>
    </div>
  </div>

  <script>
    const COINS = ["AAVE","ADA","APT","ARB","ATOM","AVAX","AXS","BCH","BNB","BTC","DOGE","DOT","ETH","FET","FIL","FLUX","ICP","INJ","LDO","LINK","LTC","NEAR","OP","PEPE","POL","RATS","RENDER","RUNE","SEI","SHIB","SOL","SUI","TIA","TNSR","TON","TRX","UNI","WIF","XRP"];

    const $ = (id)=>document.getElementById(id);

    let side = "LONG";

    function setUpdated(v){
      $("lblUpdated").textContent = v || "—";
    }

    function to2(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "—";
      return x.toFixed(2);
    }
    function to3(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "—";
      return x.toFixed(3);
    }
    function fmtDateBR_fromYMD(s){
      // "2026-01-24" -> "24/01/2026"
      if (!s) return "—";
      const t = String(s).trim();
      if (t.includes("/")) return t; // já está BR
      const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return t;
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function fmtDateBR(d){
      try{ return d.toLocaleDateString("pt-BR"); }catch{ return "—"; }
    }
    function fmtTimeBR(d){
      try{
        return d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
      }catch{ return "—"; }
    }

    function regFromOp(op){
      // pedido 1/2: se created_ts falhar, usa o timestamp do ID (PAR-<epoch>)
      let dt = null;

      if (op && op.created_ts){
        const d = new Date(op.created_ts);
        if (!isNaN(d.getTime())) dt = d;
      }

      if (!dt){
        const id = String(op?.id || "");
        const m = id.match(/-(\d{10,})$/);
        if (m){
          const d2 = new Date(Number(m[1]));
          if (!isNaN(d2.getTime())) dt = d2;
        }
      }

      if (!dt) return {date:"—", time:"—"};
      return {date: fmtDateBR(dt), time: fmtTimeBR(dt)};
    }

    function paintSide(){
      $("btnLong").classList.toggle("on", side==="LONG");
      $("btnShort").classList.toggle("on", side==="SHORT");
      $("btnLong").classList.toggle("long", true);
      $("btnShort").classList.toggle("short", true);
    }

    function ensureMoedas(){
      const sel = $("par");
      sel.innerHTML = "";
      for (const c of COINS){
        const o = document.createElement("option");
        o.value = c;
        o.textContent = c;
        sel.appendChild(o);
      }
    }

    async function fetchAlvo(){
      const par = $("par").value;
      $("alvo").value = "";
      $("lblPro").textContent = "—";
      try{
        const r = await fetch(`/api/saida/alvo?par=${encodeURIComponent(par)}&side=${encodeURIComponent(side)}`);
        const j = await r.json().catch(()=>({}));
        if (!j.ok) throw new Error(j.msg || "Falha no alvo");
        $("alvo").value = String(j.alvo ?? "");
        $("lblPro").textContent = j.updated_brt ? `PRO atualizado: ${j.updated_brt}` : "OK";
      }catch(e){
        $("alvo").value = "";
        $("lblPro").textContent = (e?.message || "Sem alvo do PRO");
      }
    }

    async function addOperacao(){
      const btn = $("btnAdd");
      const par = $("par").value;

      const entrada_txt = String($("entrada").value||"").replace(",", ".").trim();
      const alav_txt = String($("alav").value||"").replace(",", ".").trim();

      const entrada = Number(entrada_txt);
      const alav = Math.floor(Number(alav_txt));

      if (!Number.isFinite(entrada) || entrada<=0) return alert("Digite ENTRADA corretamente.");
      if (!Number.isFinite(alav) || alav<1) return alert("Digite ALAV corretamente (>=1).");

      try{
        btn.disabled = true;
        const r = await fetch("/api/saida/add",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ par, side, entrada, alav })
        });
        const j = await r.json().catch(()=>({}));
        if (!j.ok) throw new Error(j.msg || "Falha ao adicionar");
        $("entrada").value = "";
        await refresh(); // aparece na hora (com DATA/HORA REG pelo ID fallback)
      }catch(e){
        alert("ERRO NO ADD: " + (e?.message || e));
      }finally{
        btn.disabled = false;
      }
    }

    async function sairOperacao(id){
      let r = await fetch("/api/saida/exit",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id })
      });
      const j = await r.json().catch(()=>({ ok:false, msg:"Falha" }));
      if (!j.ok) throw new Error(j.msg || "Falha ao sair");
    }

    async function excluirOperacao(id){
      // tenta /del, depois /delete (compat)
      let r = await fetch("/api/saida/del",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id })
      });
      if (!r.ok){
        r = await fetch("/api/saida/delete",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id })
        });
      }
      const j = await r.json().catch(()=>({}));
      if (!j.ok) throw new Error(j.msg || "Falha ao excluir");
    }

    function pctClass(v){
      const n = Number(v);
      if (!Number.isFinite(n)) return "muted";
      return n >= 0 ? "pos" : "neg";
    }

    async function refresh(){
      try{
        const [opsR, monR] = await Promise.all([
          fetch("/api/saida/ops").then(r=>r.json()).catch(()=>({ops:[]})),
          fetch("/api/saida/monitor").then(r=>r.json()).catch(()=>({ops:[], updated_brt:null}))
        ]);

        const ops = Array.isArray(opsR?.ops) ? opsR.ops : [];
        const mon = monR || { ops:[], updated_brt:null };

        setUpdated(mon.updated_brt || "—");
        $("lblTotal").textContent = String(ops.length);

        const monMap = new Map();
        if (Array.isArray(mon.ops)){
          for (const x of mon.ops){
            if (x && x.id) monMap.set(String(x.id), x);
          }
        }

        const tb = $("tbOps");
        tb.innerHTML = "";

        for (const op of ops){
          const id = String(op.id || "");
          const m = monMap.get(id) || null;

          const reg = regFromOp(op);

          const par = op.par || "—";
          const sideTxt = (op.side || "—").toUpperCase();
          const isLong = sideTxt === "LONG";

          const entrada = to3(op.entrada);
          const alvo = to3(op.alvo);
          const alav = Number(op.alav);
          const alavTxt = Number.isFinite(alav) ? String(alav) : "—";

          const atual = m ? to3(m.atual) : "—";
          const ganhoAlvo = m ? to2(m.ganho_alvo_pct) : "—";
          const ganhoAtual = m ? to2(m.ganho_atual_pct) : "—";

          const situacao = m ? (m.situacao || "—") : "AGUARDANDO WORKER";

          // data/hora atual (formata e evita quebra)
          const dataAtual = m ? fmtDateBR_fromYMD(m.data) : "—";
          const horaAtual = m ? (m.hora || "—") : "—";

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td><b>${par}</b></td>
            <td>${isLong ? `<span class="pill long">LONG</span>` : `<span class="pill short">SHORT</span>`}</td>
            <td>${entrada}</td>
            <td>${alvo}</td>
            <td>${alavTxt}</td>
            <td>${reg.date}</td>
            <td>${reg.time}</td>
            <td>${atual}</td>
            <td class="${pctClass(m?.ganho_alvo_pct)}">${ganhoAlvo}</td>
            <td class="${pctClass(m?.ganho_atual_pct)}">${ganhoAtual}</td>
            <td class="sit">${situacao}</td>
            <td class="dateAtual">${dataAtual}</td>
            <td class="horaAtual">${horaAtual}</td>
            <td>
              <button class="sbtn sair" data-id="${id}" type="button">Sair</button>
            </td>
            <td>
              <button class="sbtn del" data-id="${id}" type="button">Excluir</button>
            </td>
          `;

          tb.appendChild(tr);
        }

        // bind SAIR
        tb.querySelectorAll("button.sbtn.sair").forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute("data-id");
            if (!id) return;
            if (!confirm("Confirmar SAIR desta operação?")) return;
            try{
              b.disabled = true;
              await sairOperacao(id);
              await refresh();
            }catch(e){
              alert("ERRO NO SAIR: " + (e?.message || e));
            }finally{
              b.disabled = false;
            }
          };
        });

        // bind EXCLUIR
        tb.querySelectorAll("button.sbtn.del").forEach(b=>{
          b.onclick = async ()=>{
            const id = b.getAttribute("data-id");
            if (!id) return;
            if (!confirm("Confirmar EXCLUIR esta operação?")) return;
            try{
              b.disabled = true;
              await excluirOperacao(id);
              await refresh();
            }catch(e){
              alert("ERRO NO EXCLUIR: " + (e?.message || e));
            }finally{
              b.disabled = false;
            }
          };
        });

      }catch(e){
        // não quebra o JS por erro de rede
        console.error(e);
      }
    }

    // eventos
    $("btnLong").onclick = async ()=>{ side="LONG"; paintSide(); await fetchAlvo(); };
    $("btnShort").onclick = async ()=>{ side="SHORT"; paintSide(); await fetchAlvo(); };
    $("par").onchange = fetchAlvo;
    $("btnAdd").onclick = addOperacao;
    $("btnPdf").onclick = ()=> window.open("/api/saida/history.pdf","_blank");

    // init
    ensureMoedas();
    paintSide();
    fetchAlvo();
    refresh();
    setInterval(refresh, 15000);
  </script>
</body>
</html>
HTML
