<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AUTOTRADER-SAÍDA</title>
  <style>
    :root{
      --bg:#071f2b;
      --panel:#0a2a3a;
      --panel2:#0b3042;
      --line:rgba(255,255,255,.08);
      --txt:#e9f2f7;
      --muted:rgba(233,242,247,.7);
      --orange:#ff8a1f;
      --green:#00e676;
      --red:#ff1744;
      --yellow:#ffd54f;
      --btn:#102f41;
      --btn2:#0f3a52;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt)}
    .wrap{max-width:1400px;margin:0 auto;padding:18px 18px 28px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:28px;font-weight:800;letter-spacing:.5px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .chip{display:inline-flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:10px;font-size:12px}
    .chip b{color:var(--orange)}

    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 26px rgba(0,0,0,.25);padding:14px}
    .panel + .panel{margin-top:14px}

    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 2px}
    select,input{height:42px;background:#071c27;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:0 12px;outline:none}
    select{min-width:110px}
    input{min-width:140px}

    .sidebtns{display:flex;gap:8px}
    .btn{height:42px;border-radius:10px;border:1px solid var(--line);background:var(--btn);color:var(--txt);padding:0 14px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--btn2)}
    .btnSide{width:88px}
    .btnLong.active{outline:2px solid rgba(0,230,118,.35)}
    .btnShort.active{outline:2px solid rgba(255,23,68,.35)}

    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
    thead th{position:sticky;top:0;background:rgba(0,0,0,.18);backdrop-filter: blur(6px);border-bottom:1px solid var(--line);padding:12px 10px;text-align:left;font-size:12px;color:var(--orange)}
    tbody td{border-bottom:1px solid var(--line);padding:12px 10px;font-size:13px}
    tbody tr:hover{background:rgba(255,255,255,.03)}

    .tagLong{color:var(--green);font-weight:800}
    .tagShort{color:var(--red);font-weight:800}
    .pos{color:var(--green);font-weight:800}
    .neg{color:var(--red);font-weight:800}
    .muted{color:var(--muted)}

    .btnDel{background:#0b2230}

    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    .statusline{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">AUTOTRADER-SAÍDA</div>
        <div class="subtitle">Painel único (SAÍDA) · FUTUROS USDT · atualização do worker a cada 5 minutos</div>
      </div>
      <div class="chip">Atualizado: <b id="updated">—</b></div>
    </div>

    <div class="panel">
      <div style="font-size:22px;font-weight:900;color:var(--orange);margin:2px 0 12px">MONITORAMENTO DE SAÍDA</div>
      <div class="row">
        <div>
          <label>Par</label>
          <select id="par"></select>
        </div>

        <div>
          <label>Side</label>
          <div class="sidebtns">
            <button class="btn btnSide btnLong" id="btnLong">LONG</button>
            <button class="btn btnSide btnShort" id="btnShort">SHORT</button>
          </div>
        </div>

        <div>
          <label>Entrada</label>
          <input id="entrada" inputmode="decimal" placeholder="0.000" />
        </div>

        <div>
          <label>Alav</label>
          <input id="alav" inputmode="numeric" placeholder="1" />
        </div>

        <div style="padding-top:18px">
          <button class="btn" id="btnAdd">Adicionar Operação</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>PAR</th>
            <th>SIDE</th>
            <th>ENTRADA</th>
            <th>ATUAL</th>
            <th>ALVO</th>
            <th>PNL%</th>
            <th>ETA</th>
            <th>SITUAÇÃO</th>
            <th>DATA</th>
            <th>HORA</th>
            <th>ALAV</th>
            <th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>

      <div class="foot">
        <div class="statusline">
          <span class="pill">Auto-refresh ligado.</span>
          <span class="pill">Worker: 5 min</span>
          <span class="pill">Tela: 15 s</span>
        </div>
      </div>
    </div>
  </div>

<script>
  const UNIVERSE_77 = ['AAVE','ADA','APE','APT','AR','ARB','ATOM','AVAX','AXS','BAT','BCH','BLUR','BNB','BONK','BTC','COMP','CRV','DASH','DENT','DGB','DOGE','DOT','EGLD','SUI','ETC','ETH','FET','FIL','FLOKI','FLOW','S','GALA','GLM','GRT','HBAR','ICP','IMX','INJ','IOST','KAS','KAVA','KSM','LINK','LTC','MANA','POL','SKY','NEAR','NEO','OMG','ONT','OP','ORDI','PEPE','QNT','QTUM','RENDER','ROSE','RUNE','SAND','SEI','SHIB','SNX','SOL','STX','SUSHI','THETA','TIA','TRX','UNI','VET','XEM','XLM','XRP','XVS','ZEC','ZRX'];

  const $ = (id)=>document.getElementById(id);
  const parSel = $('par');
  const tb = $('tb');
  const updated = $('updated');

  let side = 'LONG';
  function setSide(s){
    side = s;
    $('btnLong').classList.toggle('active', s==='LONG');
    $('btnShort').classList.toggle('active', s==='SHORT');
  }

  $('btnLong').onclick = ()=>setSide('LONG');
  $('btnShort').onclick = ()=>setSide('SHORT');
  setSide('LONG');

  function fmt3(x){
    const n = Number(x);
    if(!Number.isFinite(n)) return '—';
    return n.toFixed(3);
  }
  function fmt2(x){
    const n = Number(x);
    if(!Number.isFinite(n)) return '—';
    return n.toFixed(2);
  }

  function renderRows(rows){
    tb.innerHTML = '';
    for(const r of rows){
      const tr = document.createElement('tr');
      const clsSide = (String(r.side||'')==='SHORT') ? 'tagShort' : 'tagLong';
      const pnl = Number(r.pnl_pct);
      const clsPnl = Number.isFinite(pnl) ? (pnl>=0 ? 'pos':'neg') : '';
      tr.innerHTML = `
        <td>${r.par||'—'}</td>
        <td class="${clsSide}">${r.side||'—'}</td>
        <td>${fmt3(r.entrada)}</td>
        <td>${fmt3(r.atual)}</td>
        <td>${fmt3(r.alvo)}</td>
        <td class="${clsPnl}">${fmt2(r.pnl_pct)}%</td>
        <td>${r.eta||'—'}</td>
        <td>${r.situacao||'—'}</td>
        <td>${r.data||'—'}</td>
        <td>${r.hora||'—'}</td>
        <td>${r.alav||'—'}</td>
        <td><button class="btn btnDel" data-id="${r.id}">Excluir</button></td>
      `;
      tb.appendChild(tr);
    }

    tb.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.getAttribute('data-id');
        await fetch(`/api/saida/ops/${encodeURIComponent(id)}`, { method:'DELETE' });
        await load();
      }
    });
  }

  async function load(){
    const r = await fetch('/api/saida/monitor', { cache:'no-store' });
    const j = await r.json();
    updated.textContent = j.updated_brt || '—';
    renderRows(Array.isArray(j.ops)? j.ops : []);
  }

  $('btnAdd').onclick = async ()=>{
    const par = String(parSel.value||'').trim().toUpperCase();
    const entrada = Number(String($('entrada').value||'').replace(',','.'));
    const alav = Number(String($('alav').value||'').replace(',','.'));

    if(!par || !Number.isFinite(entrada) || entrada<=0 || !Number.isFinite(alav) || alav<=0){
      alert('Preencha PAR, ENTRADA e ALAV corretamente.');
      return;
    }

    const resp = await fetch('/api/saida/ops', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ par, side, entrada, alav })
    });

    if(!resp.ok){
      const err = await resp.json().catch(()=>({error:'erro'}));
      alert(err.error || 'Erro ao adicionar');
      return;
    }

    $('entrada').value='';
    await load();
  };

  // popula dropdown
  for(const c of UNIVERSE_77){
    const o = document.createElement('option');
    o.value = c;
    o.textContent = c;
    parSel.appendChild(o);
  }
  parSel.value = 'BTC';

  load();
  setInterval(load, 15000);
</script>
</body>
</html>
