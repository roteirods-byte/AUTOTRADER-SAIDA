<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUTOTRADER-SAÍDA</title>
  <style>
    :root {
      --bg0: #071a22;
      --card: rgba(3, 44, 56, 0.55);
      --line: rgba(255,255,255,0.08);
      --text: #e9f4f7;
      --muted: rgba(233,244,247,0.65);
      --orange: #ff8a00;
      --green: #21e6a5;
      --red: #ff3b70;
      --shadow: 0 14px 40px rgba(0,0,0,0.35);
      --radius: 22px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, #093241 0%, var(--bg0) 55%, #041017 100%);
    }
    .wrap { max-width: 1480px; margin: 28px auto 60px; padding: 0 18px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 12px; }
    h1 { margin:0; letter-spacing:1px; font-size:44px; font-weight:800; }
    .sub { margin-top:2px; color:var(--muted); font-size:14px; }
    .badge {
      padding: 10px 14px; border:1px solid var(--line); background: rgba(0,0,0,0.15);
      border-radius: 999px; min-width:220px; text-align:right; box-shadow: var(--shadow);
    }
    .badge b { color: var(--orange); font-weight: 800; }
    .card {
      margin-top:18px; border-radius: var(--radius); border:1px solid var(--line);
      background: linear-gradient(180deg, var(--card) 0%, rgba(3, 44, 56, 0.18) 100%);
      box-shadow: var(--shadow); padding: 18px 18px 16px;
    }
    .card h2 { margin:0 0 10px; color:var(--orange); font-size:18px; letter-spacing:1px; }
    .row { display:grid; grid-template-columns: 160px 200px 1fr 1fr 120px 160px; gap:14px; align-items:end; }
    label { display:block; font-size:11px; color:var(--muted); margin-bottom:6px; letter-spacing:.6px; text-transform:uppercase; }
    select,input {
      width:100%; background: rgba(0,0,0,0.18); color:var(--text);
      border:1px solid rgba(255,255,255,0.10); border-radius:12px; padding:12px 12px; outline:none;
    }
    input::placeholder { color: rgba(233,244,247,0.35); }
    .sideBox { display:flex; gap:10px; }
    .pill {
      flex:1; border-radius:12px; padding:11px 12px; border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12); color:var(--text); cursor:pointer; font-weight:800; letter-spacing:.6px;
    }
    .pill.on.long { border-color: rgba(33,230,165,0.6); box-shadow: 0 0 0 2px rgba(33,230,165,0.18) inset; }
    .pill.on.short { border-color: rgba(255,59,112,0.6); box-shadow: 0 0 0 2px rgba(255,59,112,0.18) inset; }
    .btn {
      width:100%; border-radius:12px; padding:12px 12px; border:1px solid rgba(255,138,0,0.55);
      background: rgba(0,0,0,0.10); color:var(--orange); cursor:pointer; font-weight:900; letter-spacing:.4px;
    }
    .muteline { margin-top:10px; color:var(--muted); font-size:13px; }
    .muteline b { color: var(--orange); }
    .err { margin-top:10px; color: var(--red); font-weight:800; font-size:13px; letter-spacing:.4px; }
    .tblTop { display:flex; gap:12px; align-items:center; margin:8px 0 12px; }
    .btnSmall {
      border-radius:12px; padding:10px 14px; border:1px solid rgba(255,138,0,0.55);
      background: rgba(0,0,0,0.10); color:var(--orange); cursor:pointer; font-weight:900; letter-spacing:.4px;
    }
    table {
      width:100%; border-collapse:collapse; overflow:hidden; border-radius:16px;
      border:1px solid var(--line); background: rgba(0,0,0,0.12);
    }
    thead th {
      color:var(--orange); font-size:12px; letter-spacing:.8px; text-transform:uppercase;
      padding:12px 10px; border-bottom:1px solid var(--line); white-space:nowrap;
    }
    tbody td { padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.06); font-size:13px; white-space:nowrap; }
    tbody tr:last-child td { border-bottom:none; }
    .sidePill {
      display:inline-block; padding:6px 10px; border-radius:999px; font-weight:900; letter-spacing:.5px;
      border:1px solid rgba(255,255,255,0.10);
    }
    .sidePill.long { color: var(--green); border-color: rgba(33,230,165,0.35); }
    .sidePill.short { color: var(--red); border-color: rgba(255,59,112,0.35); }
    .pos { color: var(--green); font-weight:900; }
    .neg { color: var(--red); font-weight:900; }
    .btnSair {
      border-radius:12px; padding:10px 14px; border:1px solid rgba(33,230,165,0.55);
      background: rgba(0,0,0,0.10); color: var(--orange); cursor:pointer; font-weight:900;
    }
    .btnDel {
      border-radius:12px; padding:10px 14px; border:1px solid rgba(255,59,112,0.55);
      background: rgba(0,0,0,0.10); color: var(--red); cursor:pointer; font-weight:900; margin-left:10px;
    }
    th:nth-child(1), td:nth-child(1) { width: 70px; }
    th:nth-child(2), td:nth-child(2) { width: 110px; }
    th:nth-child(3), td:nth-child(3) { width: 95px; }
    th:nth-child(4), td:nth-child(4) { width: 95px; }
    th:nth-child(5), td:nth-child(5) { width: 70px; }
    th:nth-child(6), td:nth-child(6) { width: 115px; }
    th:nth-child(7), td:nth-child(7) { width: 95px; }
    th:nth-child(8), td:nth-child(8) { width: 95px; }
    th:nth-child(9), td:nth-child(9) { width: 110px; }
    th:nth-child(10), td:nth-child(10) { width: 120px; }
    th:nth-child(11), td:nth-child(11) { width: 150px; }
    th:nth-child(12), td:nth-child(12) { width: 115px; }
    th:nth-child(13), td:nth-child(13) { width: 95px; }
    th:nth-child(14), td:nth-child(14) { width: 110px; }
    th:nth-child(15), td:nth-child(15) { width: 120px; }
    .footer { display:flex; gap:10px; margin-top:10px; color:var(--muted); font-size:12px; flex-wrap:wrap; }
    .chip { border:1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.12); padding:6px 10px; border-radius:999px; }
    @media (max-width: 980px) {
      .row { grid-template-columns: 1fr 1fr; }
      .badge { min-width: 0; text-align: left; }
      h1 { font-size: 34px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>AUTOTRADER-SAÍDA</h1>
        <div class="sub">Página única (SAÍDA): Entrada da operação + Monitoramento automático</div>
      </div>
      <div class="badge">Atualizado: <b id="updated">—</b></div>
    </div>

    <div class="card">
      <h2>DADOS DE ENTRADA NA OPERAÇÃO</h2>

      <div class="row">
        <div>
          <label>PAR</label>
          <select id="par"></select>
        </div>

        <div>
          <label>SIDE</label>
          <div class="sideBox">
            <button id="btnLong" class="pill long on long" type="button">LONG</button>
            <button id="btnShort" class="pill short" type="button">SHORT</button>
          </div>
        </div>

        <div>
          <label>ENTRADA</label>
          <input id="entrada" inputmode="decimal" placeholder="ex: 1.234" />
        </div>

        <div>
          <label>US ALVO (do PRO, congelado)</label>
          <input id="alvoPro" readonly placeholder="—" />
        </div>

        <div>
          <label>ALAV</label>
          <input id="alav" inputmode="numeric" value="10" />
        </div>

        <div>
          <button id="btnAdd" class="btn" type="button">Adicionar Operação</button>
        </div>
      </div>

      <div class="muteline">Alvo do PRO: <b id="proUpdated">—</b></div>
      <div id="errAlvo" class="err" style="display:none;">ERRO: HTTP 400</div>
    </div>

    <div class="card">
      <h2>MONITORAMENTO DAS OPERAÇÕES</h2>

      <div class="tblTop">
        <div style="color:var(--muted);font-size:13px;">Total: <b id="totalOps" style="color:var(--text);">0</b></div>
        <button id="btnPdf" class="btnSmall" type="button">Baixar PDF</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>PAR</th><th>SIDE</th><th>ENTRADA</th><th>ALVO</th><th>ALAV</th>
            <th>DATA REG</th><th>HORA REG</th>
            <th>ATUAL</th><th>GANHO ALVO</th><th>GANHO ATUAL</th>
            <th>SITUAÇÃO</th><th>DATA ATUAL</th><th>HORA ATUAL</th>
            <th>SAIR</th><th>EXCLUIR</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="15" style="color:var(--muted);padding:14px 10px;">Carregando...</td></tr>
        </tbody>
      </table>

      <div class="footer">
        <span class="chip">Auto-refresh: 15s</span>
        <span class="chip">Worker: 5 min</span>
        <span class="chip">ALVO fixo (congelado no ADD)</span>
      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  const COINS = ["AAVE", "ADA", "APT", "ARB", "ATOM", "AVAX", "AXS", "BCH", "BNB", "BTC", "DOGE", "DOT", "ETH", "FET", "FIL", "FLUX", "ICP", "INJ", "LDO", "LINK", "LTC", "NEAR", "OP", "PEPE", "POL", "RATS", "RENDER", "RUNE", "SEI", "SHIB", "SOL", "SUI", "TIA", "TNSR", "TON", "TRX", "UNI", "WIF", "XRP"];
  const $ = (id) => document.getElementById(id);

  let currentSide = "LONG";

  function setSide(side) {
    currentSide = side;
    $("btnLong").classList.toggle("on", side === "LONG");
    $("btnShort").classList.toggle("on", side === "SHORT");
    $("btnLong").classList.toggle("long", true);
    $("btnShort").classList.toggle("short", true);
    fetchAlvo().catch(()=>{});
  }

  function fillCoins() {
    const sel = $("par");
    sel.innerHTML = "";
    for (const c of COINS) {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    }
    sel.value = COINS[0] || "";
  }

  async function jget(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) {
      let msg = "HTTP " + r.status;
      try { const j = await r.json(); if (j && j.msg) msg = j.msg; } catch (e) {}
      const err = new Error(msg); err.status = r.status; throw err;
    }
    return await r.json();
  }

  async function jpost(url, bodyObj) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj || {}),
      cache: "no-store",
    });
    if (!r.ok) {
      let msg = "HTTP " + r.status;
      try { const j = await r.json(); if (j && j.msg) msg = j.msg; } catch (e) {}
      const err = new Error(msg); err.status = r.status; throw err;
    }
    return await r.json();
  }

  function fmtNum(x, dec=3) {
    if (x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "—";
    return Number(x).toFixed(dec);
  }
  function fmtPct(x) {
    if (x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "—";
    const n = Number(x);
    return (n >= 0 ? "+" : "") + n.toFixed(2) + "%";
  }
  function splitDateTime(updated_brt) {
    if (!updated_brt || typeof updated_brt !== "string") return ["—","—"];
    const parts = updated_brt.split(" ");
    if (parts.length < 2) return [updated_brt, "—"];
    return [parts[0], parts[1]];
  }
  function regFromCreatedTs(created_ts) {
    if (!created_ts) return ["—","—"];
    const dt = new Date(created_ts);
    if (isNaN(dt.getTime())) return ["—","—"];
    const d = dt.toLocaleDateString("pt-BR");
    const t = dt.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
    return [d, t];
  }

  async function fetchAlvo() {
    const parVal = $("par").value || "";
    const sideVal = currentSide;
    if (!parVal || (sideVal !== "LONG" && sideVal !== "SHORT")) {
      $("alvoPro").value = "—";
      $("proUpdated").textContent = "—";
      $("errAlvo").style.display = "none";
      return;
    }
    try {
      const j = await jget(`/api/saida/alvo?par=${encodeURIComponent(parVal)}&side=${encodeURIComponent(sideVal)}`);
      $("alvoPro").value = (j && j.alvo !== undefined) ? String(j.alvo) : "—";
      $("proUpdated").textContent = (j && j.updated_brt) ? j.updated_brt : "—";
      $("errAlvo").style.display = "none";
    } catch (e) {
      $("alvoPro").value = "—";
      $("proUpdated").textContent = "—";
      $("errAlvo").style.display = "block";
      console.error("fetchAlvo erro:", e);
    }
  }

  async function loadAndRender() {
    const opsResp = await jget("/api/saida/ops");
    const opsList = (opsResp && Array.isArray(opsResp.ops)) ? opsResp.ops : [];

    const monResp = await jget("/api/saida/monitor");
    const monList = (monResp && Array.isArray(monResp.ops)) ? monResp.ops : [];

    $("updated").textContent = (monResp && monResp.updated_brt) ? monResp.updated_brt : "—";

    const monById = new Map();
    for (const o of monList) if (o && o.id) monById.set(o.id, o);

    $("totalOps").textContent = String(opsList.length || 0);
    const [dAtual, hAtual] = splitDateTime(monResp && monResp.updated_brt);

    const tb = $("tbody");
    tb.innerHTML = "";
    if (!opsList.length) {
      tb.innerHTML = '<tr><td colspan="15" style="color:rgba(233,244,247,0.65);padding:14px 10px;">Sem operações.</td></tr>';
      return;
    }

    for (const baseOp of opsList) {
      const mo = monById.get(baseOp.id) || {};

      const par = baseOp.par || "—";
      const side = (baseOp.side || "").toUpperCase();
      const [dReg, hReg] = regFromCreatedTs(baseOp.created_ts);

      const atual = (mo.atual !== undefined) ? mo.atual : null;
      const ganhoAlvo = (mo.ganho_alvo_pct !== undefined) ? mo.ganho_alvo_pct : null;
      const ganhoAtual = (mo.ganho_atual_pct !== undefined) ? mo.ganho_atual_pct : null;

      const situacao = (mo.situacao !== undefined && mo.situacao !== null && mo.situacao !== "")
        ? mo.situacao
        : (atual ? "" : "AGUARDANDO WORKER");

      const tr = document.createElement("tr");

      const tdPar = document.createElement("td");
      tdPar.textContent = par; tdPar.style.color = "var(--orange)"; tdPar.style.fontWeight = "900";

      const tdSide = document.createElement("td");
      const sp = document.createElement("span");
      sp.className = "sidePill " + (side === "LONG" ? "long" : "short");
      sp.textContent = side || "—";
      tdSide.appendChild(sp);

      const tdEntrada = document.createElement("td"); tdEntrada.textContent = fmtNum(baseOp.entrada, 3);
      const tdAlvo = document.createElement("td"); tdAlvo.textContent = fmtNum(baseOp.alvo, 3);
      const tdAlav = document.createElement("td"); tdAlav.textContent = (baseOp.alav !== undefined && baseOp.alav !== null) ? String(baseOp.alav) : "—";
      const tdDReg = document.createElement("td"); tdDReg.textContent = dReg;
      const tdHReg = document.createElement("td"); tdHReg.textContent = hReg;
      const tdAtual = document.createElement("td"); tdAtual.textContent = fmtNum(atual, 3);

      const tdGAlvo = document.createElement("td");
      tdGAlvo.textContent = fmtPct(ganhoAlvo);
      if (ganhoAlvo !== null && ganhoAlvo !== undefined && !Number.isNaN(Number(ganhoAlvo))) tdGAlvo.className = (Number(ganhoAlvo) >= 0) ? "pos" : "neg";

      const tdGAtual = document.createElement("td");
      tdGAtual.textContent = fmtPct(ganhoAtual);
      if (ganhoAtual !== null && ganhoAtual !== undefined && !Number.isNaN(Number(ganhoAtual))) tdGAtual.className = (Number(ganhoAtual) >= 0) ? "pos" : "neg";

      const tdSit = document.createElement("td"); tdSit.textContent = situacao || "—";
      const tdDA = document.createElement("td"); tdDA.textContent = dAtual;
      const tdHA = document.createElement("td"); tdHA.textContent = hAtual;

      const tdSair = document.createElement("td");
      const btnSair = document.createElement("button");
      btnSair.className = "btnSair"; btnSair.textContent = "SAIR";
      btnSair.addEventListener("click", async () => {
        if (!confirm("Confirmar SAIR desta operação?")) return;
        try { await jpost("/api/saida/sair", { id: baseOp.id }); await refresh(); }
        catch (e) { alert("ERRO NO SAIR: " + (e?.message || e)); }
      });
      tdSair.appendChild(btnSair);

      const tdDel = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.className = "btnDel"; btnDel.textContent = "EXCLUIR";
      btnDel.addEventListener("click", async () => {
        if (!confirm("Confirmar EXCLUIR esta operação?")) return;
        try { await jpost("/api/saida/excluir", { id: baseOp.id }); await refresh(); }
        catch (e) { alert("ERRO NO EXCLUIR: " + (e?.message || e)); }
      });
      tdDel.appendChild(btnDel);

      for (const td of [tdPar, tdSide, tdEntrada, tdAlvo, tdAlav, tdDReg, tdHReg, tdAtual, tdGAlvo, tdGAtual, tdSit, tdDA, tdHA, tdSair, tdDel]) tr.appendChild(td);
      tb.appendChild(tr);
    }
  }

  async function addOp() {
    const parVal = $("par").value || "";
    const sideVal = currentSide;
    const entradaVal = $("entrada").value || "";
    const alavVal = $("alav").value || "";

    if (!parVal) return alert("Selecione o PAR.");
    if (sideVal !== "LONG" && sideVal !== "SHORT") return alert("Selecione LONG ou SHORT.");
    const entradaNum = Number(String(entradaVal).replace(",", "."));
    const alavNum = Number(String(alavVal).replace(",", "."));
    if (!isFinite(entradaNum) || entradaNum <= 0) return alert("Entrada inválida.");
    if (!isFinite(alavNum) || alavNum <= 0) return alert("Alav inválida.");

    let alvoNum = null;
    try {
      const j = await jget(`/api/saida/alvo?par=${encodeURIComponent(parVal)}&side=${encodeURIComponent(sideVal)}`);
      alvoNum = (j && j.alvo !== undefined) ? Number(j.alvo) : null;
    } catch (e) {
      alvoNum = null;
    }

    try {
      await jpost("/api/saida/add", {
        par: parVal, side: sideVal, entrada: entradaNum, alav: alavNum,
        alvo: (isFinite(alvoNum) ? alvoNum : undefined),
      });
      $("entrada").value = "";
      await refresh();
    } catch (e) {
      alert("ERRO NO ADD: " + (e?.message || e));
    }
  }

  async function refresh() {
    try { await loadAndRender(); }
    catch (e) {
      console.error("refresh erro:", e);
      $("tbody").innerHTML = '<tr><td colspan="15" style="color:rgba(233,244,247,0.65);padding:14px 10px;">ERRO ao carregar dados.</td></tr>';
    }
  }
  window.refresh = refresh;

  fillCoins();
  $("btnLong").addEventListener("click", () => setSide("LONG"));
  $("btnShort").addEventListener("click", () => setSide("SHORT"));
  $("par").addEventListener("change", () => fetchAlvo().catch(()=>{}));
  $("btnAdd").addEventListener("click", () => addOp().catch(()=>{}));
  $("btnPdf").addEventListener("click", () => window.print());

  fetchAlvo().catch(()=>{});
  refresh().catch(()=>{});
  setInterval(() => refresh().catch(()=>{}), 15000);
})();
</script>
</body>
</html>
